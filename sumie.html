<!DOCTYPE html>
<html>
	<head>
		<title>Sumie</title>
		<script>
			var brushCanvas;
			var brushContext;
			var oldScale = 0.0;
			var oldestScale = 0.0;

			var oldestX = -1;
			var oldestX = -1;
			var oldX = -1;
			var oldY = -1;

			var currentX = -1;
			var currentY = -1;
			var mousePressed = false;
			var brushTexture = new Image();
			var maxStrokeLength = 50; //From experiments of fast stylus dragging
			var radius = 20;
			var points = [];

			// window.onload = function()
			// {
			// 	brushCanvas = document.getElementById("brushCanvas");
			// 	brushContext = brushCanvas.getContext("2d");
			// 	brushContext.lineCap = "round";
			// 	brushContext.lineJoin = "round";
			// 	brushContext.lineWidth = 0.01;
			// }

			function length(x, y)
			{
				return Math.sqrt(x * x + y * y);
			}

			function lengthSquared(x, y)
			{
				return x * x + y * y;
			}

			function angleBetweenPoints(x1, y1, x2, y2)
			{
				newX = x2-x1;
				newY = y2-y1;
				return Math.atan(newY / newX);
			}

			function lerp(a, b, t)
			{
				return a + (b-a) * t;
			}

			function quadCurve(a, b, c, t)
			{
				return a * (1-t) * (1-t) + 2 * (1-t) * t * b + t * t * c;
			}

			function drawRotatedImage(image, x, y, angle, scale)
			{
				brushContext.save();
				brushContext.translate(x, y);
				brushContext.rotate(angle);
				brushContext.scale(scale, scale);
				brushContext.drawImage(image, -(image.width/2), -(image.height/2));
				brushContext.restore(); 
			}

			function beginLineBatch(context)
			{
				// Add error checking to see if we have already begun
				context.beginPath();
			}

			function batchDrawLine(x1, y1, x2, y2, context)
			{
				context.moveTo(x1, y1);
				context.lineTo(x2, y2);
			}

			function endLineBatch(context)
			{
				context.stroke();
			}

			function clamp(value, min, max)
			{
				if(value < min)
				{
					return min;
				}
				else if (value > max)
				{
					return max;
				}
				else
				{
					return value;
				}
			}

			function onMouseDown(e)
			{
				mousePressed = true;
				currentX = e.clientX;
				currentY = e.clientY;
				oldX = currentX;
				oldY = currentY;
				oldestX = oldX;
				oldestY = oldY;
			}

			function onMouseUp(e)
			{
				mousePressed = false;
			}

			function onMouseMove(e)
			{
				oldestX = oldX;
				oldestY = oldY;
				oldX = currentX;
				oldY = currentY;
				currentX = e.clientX;
				currentY = e.clientY;
			}

			function onMouseOut()
			{
				mousePressed = false;
			}

			function calculateRadius(scale)
			{
				var val = (1-scale) * radius;
				return clamp(val, radius, radius);
			}

			function calculateIterations(radius)
			{
				// Make iterations proportional to radius
				//var val = (1-radius) * 400;
				//return clamp(val, 50, 400);

				//return Math.PI * radius * radius * 0.05;
				return radius * 4;
			}

			function drawBrushCircle(x, y, xDir, yDir, scale)
			{
				var radius = calculateRadius(scale);
				//document.getElementById("debug").innerHTML = "Radius: " + radius;
				var iterations = calculateIterations(radius);
				document.getElementById("debug").innerHTML = "Iterations: " + iterations;
				var perpDirX = -yDir;
				var perpDirY = xDir;
				brushContext.lineWidth = lerp(0.005, 0.09, (1-scale));
				beginLineBatch(brushContext);
				for (var i = 0; i < iterations; i++)
				{
					var randX = x + (Math.random() * 2 * radius) - radius;
					var randY = y + (Math.random() * 2 * radius) - radius;
					if(lengthSquared(randX - x, randY - y) > (radius * radius))
					{
						continue;
					}

					// var jitterDirX = xDir * (Math.random() * scale * 10 + 4);
					// var jitterDirY = yDir * (Math.random() * scale * 10 + 4);

					var jitterDirX = xDir;// + (1-scale) * perpDirX;
					var jitterDirY = yDir;// + (1-scale) * perpDirY;

					var maxBrushLength = 20;
					var brushLength = scale * maxBrushLength;
					brushLength = clamp(brushLength, 0.5 * maxBrushLength, maxBrushLength);

					jitterDirX *= brushLength;
					jitterDirY *= brushLength;

					batchDrawLine(randX - jitterDirX, randY - jitterDirY, randX + jitterDirX, randY + jitterDirY, brushContext);
				}
				endLineBatch(brushContext);
			}

			function drawBrushStroke()
			{
				if(!mousePressed)
				{
					return;
				}

				var dirX = currentX - oldX;
				var dirY = currentY - oldY;
				var len = length(dirX, dirY);
				if (len == 0)
				{
					// drawBrushCircle(
					// 	currentX,
					// 	currentY,
					// 	Math.random(),
					// 	Math.random(),
					// 	0.0);
					return;
				}

				dirX /= len;
				dirY /= len;

				var scale = len / maxStrokeLength;
				scale = clamp(scale, 0.0, 1.0);

				document.getElementById("debug").innerHTML = "Scale: " + scale;

				var midX1 = (oldX + oldestX) * 0.5;
				var midY1 = (oldY + oldestY) * 0.5;
				var midX2 = (oldX + currentX) * 0.5;
				var midY2 = (oldY + currentY) * 0.5;

				var midScale1 = (oldScale + oldestScale) * 0.5;
				var midScale2 = (oldScale + scale) * 0.5;

				var pixelFreq = 1;
				var count = len / pixelFreq;
				for (var i = 0; i <= count; i++)
				{
					var amt1 = i / count;

					// drawBrushCircle(
					// 	lerp(oldX, currentX, amt1),
					// 	lerp(oldY, currentY, amt1),
					// 	dirX,
					// 	dirY,
					// 	lerp(oldScale, scale, amt1));

					drawBrushCircle(
						quadCurve(midX1, oldX, midX2, amt1),
						quadCurve(midY1, oldY, midY2, amt1),
						dirX,
						dirY,
						quadCurve(midScale1, oldScale, midScale2, amt1));
				}

				oldestScale = oldScale;
				oldScale = scale;
			}

			// shim layer with setTimeout fallback
			// window.requestAnimFrame = (function(){
			// 	return  window.requestAnimationFrame ||
			// 			window.webkitRequestAnimationFrame ||
			// 			window.mozRequestAnimationFrame ||
			// 			function( callback ) {
			// 				window.setTimeout(callback, 1000 / 60);
			// 			};
			// })();

			// (function animloop(){
			// 	requestAnimFrame(animloop);
			// 	drawBrushStroke();
			// })();


			var drawLoop = function() {
				drawBrushStroke();
				setTimeout(drawLoop, 10);
			};
			window.document.addEventListener("DOMContentLoaded", function()
			{
				brushCanvas = document.getElementById("brushCanvas");
				brushContext = brushCanvas.getContext("2d");
				brushContext.lineCap = "round";
				brushContext.lineJoin = "round";
				brushContext.lineWidth = 0.1;
				drawLoop();
			});

		</script>
	</head>
	<body style="margin:0px;">

	<canvas id="brushCanvas" width="1280" height="720" onmousedown="onMouseDown(event)" onmousemove="onMouseMove(event)" onmouseout="onMouseOut()" onmouseup="onMouseUp(event)" style="background-color:#FFFFCC"></canvas>
	<p id="debug"></p>

	</body>
</html>
