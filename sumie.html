<!DOCTYPE html>
<html>
	<head>
		<title>Sumie</title>
		<script>
			var brushCanvas;
			var brushContext;
			var oldX = -1;
			var oldY = -1;
			var currentX = -1;
			var currentY = -1;
			var mousePressed = false;
			var brushTexture = new Image();
			brushTexture.src = "images/brush2Black.png";

			window.onload = function()
			{
				brushCanvas = document.getElementById("brushCanvas");
				brushContext = brushCanvas.getContext("2d");
				brushContext.lineCap = "round";
				brushContext.lineJoin = "round";
				brushContext.lineWidth = 0.1;
			}

			function angleBetweenPoints(x1, y1, x2, y2)
			{
				newX = x2-x1;
				newY = y2-y1;
				return Math.atan(newY / newX);
			}

			function lerp(a, b, amount)
			{
				return a + (b-a) * amount;
			}

			function drawRotatedImage(image, x, y, angle, scale)
			{
				brushContext.save();
				brushContext.translate(x, y);
				brushContext.rotate(angle);
				brushContext.scale(scale, scale);
				brushContext.drawImage(image, -(image.width/2), -(image.height/2));
				brushContext.restore(); 
			}

			function drawLine(x1, y1, x2, y2, context)
			{
				context.beginPath();
				context.moveTo(x1, y1);
				context.lineTo(x2, y2);
				context.stroke();
			}

			function drawBrushCircle(x, y, xDir, yDir, length)
			{
				//Calculate radius...
				var radius = 12;
				for (var i = 0; i < 225; i++)
				{
					var randAngle = Math.random() * 2 * Math.PI;
					var randLength = Math.random() * radius;
					var randX = x + (Math.cos(randAngle) * randLength);
					var randY = y + (Math.sin(randAngle) * randLength);

					var jitterDirX = xDir * (Math.random() * length * 0.09 + 4);
					var jitterDirY = yDir * (Math.random() * length * 0.09 + 4);
					drawLine(randX - jitterDirX, randY - jitterDirY, randX + jitterDirX, randY + jitterDirY, brushContext);
				}
			}

			function onMouseDown(e)
			{
				mousePressed = true;
				oldX = e.clientX;
				oldY = e.clientY;
				currentX = oldX;
				currentY = oldY;
			}

			function onMouseUp(e)
			{
				mousePressed = false;
			}

			function onMouseMove(e)
			{
				if(!mousePressed)
				{
					return;
				}
				oldX = currentX;
				oldY = currentY;
				currentX = e.clientX;
				currentY = e.clientY;
				coor = "Coordinates: (" + currentX + "," + currentY + ")";
				var dirX = currentX - oldX;
				var dirY = currentY - oldY;
				var len = Math.sqrt(dirX * dirX + dirY * dirY);
				if (len == 0)
				{
					return;
				}

				dirX /= len;
				dirY /= len;

				document.getElementById("debug").innerHTML = "Length: " + len;
				var scale = lerp(0.3, 1.0, len / 50);
				document.getElementById("debug").innerHTML = "Scale: " + scale;
				scale = 1 - scale;

				drawLine(oldX, oldY, currentX, currentY, brushContext);

				var pixelFreq = 3;
				var count = len / pixelFreq;
				for (var i = 0; i <= count; i++)
				{
					var amt1 = i / count;

					drawBrushCircle(
						lerp(oldX, currentX, amt1),
						lerp(oldY, currentY, amt1),
						dirX,
						dirY,
						len);
				}
				// drawRotatedImage(brushTexture, currentX, currentY, angleBetweenPoints(oldX, oldY, currentX, currentY), scale);
			}

			function onMouseOut()
			{
				mousePressed = false;
				document.getElementById("debug").innerHTML="";
			}

		</script>
	</head>
	<body style="margin:0px;">

	<canvas id="brushCanvas" width="1280" height="720" onmousedown="onMouseDown(event)" onmousemove="onMouseMove(event)" onmouseout="onMouseOut()" onmouseup="onMouseUp(event)" style="background-color:#CCCCFF"></canvas>
	<p id="debug"></p>

	</body>
</html>
