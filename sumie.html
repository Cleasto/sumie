<!DOCTYPE html>
<html>
	<head>
		<title>Sumie</title>
		<script>
			var brushCanvas;
			var brushContext;
			var prevScale = 1.0;
			var oldX = -1;
			var oldY = -1;
			var currentX = -1;
			var currentY = -1;
			var mousePressed = false;
			var brushTexture = new Image();

			window.onload = function()
			{
				brushCanvas = document.getElementById("brushCanvas");
				brushContext = brushCanvas.getContext("2d");
				brushContext.lineCap = "round";
				brushContext.lineJoin = "round";
				brushContext.lineWidth = 0.1;
			}

			function length(x, y)
			{
				return Math.sqrt(x * x + y * y);
			}

			function lengthSquared(x, y)
			{
				return x * x + y * y;
			}

			function angleBetweenPoints(x1, y1, x2, y2)
			{
				newX = x2-x1;
				newY = y2-y1;
				return Math.atan(newY / newX);
			}

			function lerp(a, b, amount)
			{
				return a + (b-a) * amount;
			}

			function drawRotatedImage(image, x, y, angle, scale)
			{
				brushContext.save();
				brushContext.translate(x, y);
				brushContext.rotate(angle);
				brushContext.scale(scale, scale);
				brushContext.drawImage(image, -(image.width/2), -(image.height/2));
				brushContext.restore(); 
			}

			function beginLineBatch(context)
			{
				// Add error checking to see if we have already begun
				context.beginPath();
			}

			function batchDrawLine(x1, y1, x2, y2, context)
			{
				context.moveTo(x1, y1);
				context.lineTo(x2, y2);
			}

			function endLineBatch(context)
			{
				context.stroke();
			}

			function clamp(value, min, max)
			{
				if(value < min)
				{
					return min;
				}
				else if (value > max)
				{
					return max;
				}
				else
				{
					return value;
				}
			}

			function calculateRadius(scale)
			{
				var val = (1-scale) * 20;
				return clamp(val, 10, 20);
			}

			function calculateIterations(scale)
			{
				var val = (1-scale) * 600;
				return clamp(val, 50, 600);
			}

			function drawBrushCircle(x, y, xDir, yDir, scale)
			{
				//Calculate radius...
				document.getElementById("debug").innerHTML = "Scale: " + scale;
				var radius = calculateRadius(scale);
				//document.getElementById("debug").innerHTML = "Radius: " + radius;
				var iterations = calculateIterations(scale);
				beginLineBatch(brushContext);
				document.getElementById("debug").innerHTML = "Iterations: " + iterations;
				for (var i = 0; i < iterations; i++)
				{
					var randX = x + (Math.random() * 2 * radius) - radius;
					var randY = y + (Math.random() * 2 * radius) - radius;
					if(lengthSquared(randX - x, randY - y) > (radius * radius))
					{
						continue;
					}
					// var randAngle = Math.random() * 2 * Math.PI;
					// var randLength = Math.random() * radius;
					// var randX = x + (Math.cos(randAngle) * randLength);
					// var randY = y + (Math.sin(randAngle) * randLength);

					var jitterDirX = xDir * (Math.random() * scale * 10 + 4);
					var jitterDirY = yDir * (Math.random() * scale * 10 + 4);
					batchDrawLine(randX - jitterDirX, randY - jitterDirY, randX + jitterDirX, randY + jitterDirY, brushContext);
				}
				endLineBatch(brushContext);
			}

			function onMouseDown(e)
			{
				mousePressed = true;
				oldX = e.clientX;
				oldY = e.clientY;
				currentX = oldX;
				currentY = oldY;
			}

			function onMouseUp(e)
			{
				mousePressed = false;
			}

			function onMouseMove(e)
			{
				if(!mousePressed)
				{
					return;
				}
				oldX = currentX;
				oldY = currentY;
				currentX = e.clientX;
				currentY = e.clientY;
				



				var dirX = currentX - oldX;
				var dirY = currentY - oldY;
				var len = length(dirX, dirY);
				if (len == 0)
				{
					return;
				}

				dirX /= len;
				dirY /= len;

				var scale = len / (brushCanvas.width / 10);

				var pixelFreq = 3;
				var count = len / pixelFreq;
				for (var i = 0; i <= count; i++)
				{
					var amt1 = i / count;

					drawBrushCircle(
						lerp(oldX, currentX, amt1),
						lerp(oldY, currentY, amt1),
						dirX,
						dirY,
						lerp(prevScale, scale, amt1));
				}

				prevScale = scale;
			}

			function onMouseOut()
			{
				mousePressed = false;
				document.getElementById("debug").innerHTML="";
			}

		</script>
	</head>
	<body style="margin:0px;">

	<canvas id="brushCanvas" width="1280" height="720" onmousedown="onMouseDown(event)" onmousemove="onMouseMove(event)" onmouseout="onMouseOut()" onmouseup="onMouseUp(event)" style="background-color:#FFFFCC"></canvas>
	<p id="debug"></p>

	</body>
</html>
